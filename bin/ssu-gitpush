#!/bin/bash


SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
WORKING_DIR=$(pwd)

source ./ssu-methods

pathvar="$( cd "$( dirname $0 )" && pwd )"
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar
echo $pathvar

help_and_exit() {
    echonice " ---------------------------------";
    echonice "   Available settings:";
    echonice " ---------------------------------";
    echonice "   -c, --commit-and-push          commit and push also? enter yes to execute";
    echonice "   -m, --message                  commit message";
    echonice "   -v, --new-version              create new tag? options are no|patch|minor|major";
    echonice "   -a, --also                     also do vendor - e.g. vendor/silverstripe OR vendor/sunnysideup";
    echonice "   -t, --themes-also              include folders in themes";
    echonice " "
    echonice " ---------------------------------";
    echonice "   Example usage:"
    echonice " ---------------------------------";
    echonice "   e.g. ssu-gitpush  -m 'PATCH'   -c yes -v patch -a 'vendor/silverstripe'   -t yes  app/src ";
    echonice " ---------------------------------";
    echonice " "
    echonice " "

    exit;
}

commitAndPush="yes"
message="WIP"
dir='./'
newVersion='no'
also='nothing-here-hopefully'
alsoDoThemes='no'
while (( $# )); do
  case $1 in
    -c|--commit-and-push)  commitAndPush=$2;shift ;;
    -m|--message)          message=$2;shift ;;
    -v|--new-version)      newVersion=$2;shift ;;
    -a|--also)             also=$2;shift ;;
    -t|--themes-also)      alsoDoThemes=$2;shift ;;
    -*)                    printf 'Unknown option: %q\n\n' "$1";
                           help_and_exit 1 ;;
    *)                     dir=$1;;
  esac
  shift
done

echonice " "
echonice " "
echonice " ---------------------------------";
echonice "   Running GIT PUSH";
echonice " ---------------------------------";
echonice "   directory of script:           $SCRIPT_DIR";
echonice "   directory to commit:           $WORKING_DIR/$dir";
echonice " ---------------------------------";
echonice "   Commit and Push?:              $commitAndPush";
echonice "   Message:                       $message";
echonice "   Create New Tag?:               $newVersion";
echonice "   Also check:                    $WORKING_DIR/$also";
echonice "   Also include themes?:          $alsoDoThemes";
echonice " ---------------------------------";
echonice " "
echonice " "

echonice "   # going to right directory: $WORKING_DIR/$dir"
cd $WORKING_DIR/$dir

if test -f "$WORKING_DIR/$dir/.git/config"; then
    echonice "   # check git status"
    git status

    if [[ "$commitAndPush" == "yes" ]]; then
        echonice "   # adding files to git repo"
        git add . -A
        #git add $WORKING_DIR/$also
        #git add $WORKING_DIR/$logFile

        echonice "   # committing files to git repo"
        git commit . -m "$message"
        #git commit $WORKING_DIR/$also -m "$message"
        #git commit $WORKING_DIR/$logFile -m "$message"
    fi

    echonice "   # pulling commits from git repo"
    git pull

    if [[ "$commitAndPush" == "yes" ]]; then
        echonice "   # pushing commits to git repo"
        git push
    fi


    if [[ "$newVersion" == "patch" || "$newVersion" == "minor" || "$newVersion" == "major" ]]; then

        git fetch --all

        git tag --column
        OLD_TAG=$(git tag | sort -V | tail -1)
        # RES=$(git show-ref --tags)
        # if [ -z "$RES" ]; then
        #     OLD_TAG=1.0.0
        # else
        #     OLD_TAG=$(git describe --tags --abbrev=0 | awk -F. '{OFS="."; $NF+=0; print $0}')
        # fi

        echonice " ---------------------------------";
        echonice "   Found old Tag";
        echonice " ---------------------------------";
        echonice "   $OLD_TAG";
        echonice " ---------------------------------";


        # Build array from version string.
        a=( ${OLD_TAG//./ } )


        # Increment version numbers as requested.
        if [ ${#a[@]} -ne 3 ]
        then
            echonice " ---------------------------------";
            echonice "   ERROR $OLD_TAG (current tag) can not be parsed!"
            echonice " ---------------------------------";
            exit 1
        fi

        if [[ "$newVersion" == "major" ]]; then
          ((a[0]++))
          a[1]=0
          a[2]=0
        fi

        if [[ "$newVersion" == "minor" ]]; then
          ((a[1]++))
          a[2]=0
        fi

        if [[ "$newVersion" == "patch" ]]; then
          ((a[2]++))
        fi

        NEW_TAG="${a[0]}.${a[1]}.${a[2]}";

        echonice " ---------------------------------";
        echonice "   Found new Tag ($newVersion)";
        echonice " ---------------------------------";
        echonice "   $NEW_TAG";
        echonice " ---------------------------------";

        git tag -a $NEW_TAG -m "auto-generated linter tag"

        git push --tags

        git tag -v


    fi

    echonice " ";
    echonice " ";
    echonice " ---------------------------------";
    echonice "   # check git status"
    echonice " ---------------------------------";
    git status
    echonice " ---------------------------------";
    if output=$(git status --porcelain) && [ -z "$output" ]; then
        echonice -e "\033[0;32m ---------------------------------\e[0m";
        echonice -e "\033[0;32m   # ALL DONE\e[0m";
        echonice -e "\033[0;32m ---------------------------------\e[0m";
    else
        echonice "!"
        echonice "!"
        echonice -e "\033[1;32;41m ---------------------------------\e[0m";
        echonice -e "\033[1;32;41m ---------------------------------\e[0m";
        echonice -e "\033[1;32;41m Not all Code is Committed and Pushed\e[0m";
        echonice -e "\033[1;32;41m ---------------------------------\e[0m";
        echonice -e "\033[1;32;41m ---------------------------------\e[0m";
        echonice "!"
        echonice "!"
    fi


    if test -f "$WORKING_DIR/$also"; then
        $SCRIPT_DIR/ssu-gitpush-vendor-packages -m "'$message'" -t no -c $commitAndPush -v $newVersion $WORKING_DIR/$also
    fi

    if [[ "$alsoDoThemes" == "yes" ]]; then
        $SCRIPT_DIR/ssu-gitpush-vendor-packages -m "'$message'" -t no -c $commitAndPush -v $newVersion $WORKING_DIR/themes
    fi
else
    echonice " "
    echonice " "
    echonice " ---------------------------------";
    echonice "   ===  ERROR - NOT A GIT REPO ===";
    echonice "   "$WORKING_DIR/$dir;
    echonice "   === IS NOT A GIT REPO       ===";
    echonice " ---------------------------------";
fi

echonice " ################################################"
echonice " ################################################"
echonice " ################################################"
