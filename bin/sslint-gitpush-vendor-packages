#!/bin/bash
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
WORKING_DIR=$(pwd)

if [ "$1" != "" ]; then
    dir=$1;
else
    dir='vendor'
fi

help_and_exit() {
    echo "---------------------------------";
    echo "  Available settings:";
    echo "---------------------------------";
    echo "  -c, --commit-and-push          commit and push also? enter yes to execute";
    echo "  -m, --message                  message - e.g. Lint";
    echo "  -t, --includes-themes          include themes";
    echo ""
    echo "---------------------------------";
    echo "  Example usage:"
    echo "---------------------------------";
    echo "  sslint-gitpush-vendor-packages    -c yes   -m 'PATCH: lint'   -t yes   vendor/my-vendor-name";
    echo "---------------------------------";
    echo ""
    echo ""
    exit;
}

commitAndPush='no'
message='WIP'
alsoDoThemes='yes'
while (( $# )); do
  case $1 in
    -c|--commit-and-push)  commitAndPush=$2;shift ;;
    -t|--include-themes)   alsoDoThemes=$2;shift ;;
    -m|--message)          message=$2;shift ;;
    -*)                    printf 'Unknown option: %q\n\n' "$1";
                           help_and_exit 1 ;;
    *)                     dir=$1;;
  esac
  shift
done

echo ""
echo ""
echo "---------------------------------";
echo "  Checking Vendor Packages for Changes";
echo "---------------------------------";
echo "  directory of script:           $SCRIPT_DIR";
echo "  directory to analyse:          $WORKING_DIR/$dir";
echo "---------------------------------";
echo "  message:                       $message";
echo "  also commit?:                  $commitAndPush";
echo "  also include themes?:          $alsoDoThemes";
echo ""
echo ""

echo "------------------------------------------"
echo "check status of project in vendor"
echo "------------------------------------------"
find $WORKING_DIR/$dir -maxdepth 1 -mindepth 1 -type d -exec sh -c '(echo {}  ;  cd {}  ;  git status -s)' \;


if [[ "$commitAndPush" == "yes" ]]; then


    echo "------------------------------------------"
    echo "commit in $WORKING_DIR/$dir"
    echo "------------------------------------------"

    find $WORKING_DIR/$dir -maxdepth 1 -mindepth 1 -type d -exec sh -c '(echo {}  ;  cd {}  ; $SCRIPT_DIR/sslint-gitpush . -m $message )' \;

fi


if [[ "$alsoDoThemes" == "yes" ]]; then
    echo "------------------------------------------"
    echo "check status of project in themes"
    echo "------------------------------------------"
    find themes -maxdepth 1 -mindepth 1 -type d -exec sh -c '(echo {}  ;  cd {}  ;  git status -s)' \;

    if [[ "$commitAndPush" == "yes" ]]; then

        echo "------------------------------------------"
        echo "commit themes packages"
        echo "------------------------------------------"

        find themes -maxdepth 1 -mindepth 1 -type d -exec sh -c '(echo {}  ;  cd {}  ; $SCRIPT_DIR/sslint-gitpush . -m $message )' \;

    fi

fi

echo "################################################"
echo "################################################"
echo "################################################"
