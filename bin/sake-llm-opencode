#!/usr/bin/env bash
set -euo pipefail

############################################ BASICS
SCRIPT_DIR="${COMPOSER_RUNTIME_BIN_DIR:?COMPOSER_RUNTIME_BIN_DIR not set}"
WORKING_DIR="$(pwd)"
# shellcheck source=/dev/null
source "$SCRIPT_DIR/sake-self-methods"

############################################ DIR (first arg, only if not an option)
dir='app/client/src'
if [[ $# -gt 0 && "${1:-}" != "" && "${1:0:1}" != "-" ]]; then
    dir="$1"
    shift
fi

############################################ DEFAULTS
DEFAULT_MODEL='openai/gpt-5.1-codex'
OPEN_CODE_INSTALL_CMD='curl -fsSL https://opencode.ai/install | bash'

############################################ SETTINGS
help='no'
promptDefault="$WORKING_DIR/.agents/prompt.txt"
prompt="$promptDefault"
opencodePath='opencode'
dryRun='no'
filesPattern=''   # e.g. --files=./src/app/Tasks/*.php
apiKeyEnvName='LLM_API_KEY' # --api-key-env=NAME (source env var to read key from)

# optional overrides
modelOverride=''  # --model=provider/model-id
apiEnvOverride='' # --api-env=OPENAI_API_KEY
apiKeyOverride='' # --api-key=... (avoid; prefer env)

while (($#)); do
    case $1 in
    -h | --help)
        help='yes'
        shift
        ;;
    --prompt=*)
        prompt="${1#*=}"
        shift
        ;;
    --opencode-path=*)
        opencodePath="${1#*=}"
        shift
        ;;
    --dry-run)
        dryRun='yes'
        shift
        ;;
    --files=*)
        filesPattern="${1#*=}"
        shift
        ;;
    --model=*)
        modelOverride="${1#*=}"
        shift
        ;;
    --api-env=*)
        apiEnvOverride="${1#*=}"
        shift
        ;;
    --api-key=*)
        apiKeyOverride="${1#*=}"
        shift
        ;;
    --api-key-env=*)
        apiKeyEnvName="${1#*=}"
        shift
        ;;
    *)
        if sake_handle_help_flag "$1"; then
            shift
            continue
        fi
        dir=$1
        ;;
    esac
done

help_and_exit() {

    ECHOHEAD "OpenCode runner"
    echonice "Directory is always the first argument (kept for compatibility): $dir"
    echonice "File selection is via --files=GLOB (supports *), e.g. --files=./src/app/Tasks/*.php"

    ECHOHEAD "Current settings:"
    echonice "working dir:                 $WORKING_DIR"
    echonice "dir:                         $dir"
    echonice "files:                       ${filesPattern:-'(not set)'}"
    echonice "prompt file:                 ${prompt:-"$promptDefault"}"
    echonice "opencode path:               $opencodePath"
    echonice "dry run:                     $dryRun"
    echonice "model (override/env/default): ${modelOverride:-${LLM_MODEL:-$DEFAULT_MODEL}}"
    echonice "api env override:            ${apiEnvOverride:-'(not set)'}"
    echonice "$apiKeyEnvName:              ${LLM_API_KEY:+(set)}${LLM_API_KEY:-'(not set)'}"
    echonice "api key source env:          $apiKeyEnvName"

    ECHOHEAD "Available settings:"
    echonice "-h, --help                   show help information"
    echonice "--files=GLOB                 files to include (required)"
    echonice "--prompt=FILE                prompt file path (default: $promptDefault)"
    echonice "--opencode-path=PATH         opencode binary/path (default: opencode)"
    echonice "--model=PROVIDER/MODEL       model to use (default: $DEFAULT_MODEL)"
    echonice "--api-env=ENVVAR             force which env var to pass the key into"
    echonice "--api-key-env=ENVVAR         which env var to read the key from (default: LLM_API_KEY)"
    echonice "--dry-run                    print final command, do not run"

    ECHOHEAD "Notes:"
    echonice "For any provider, you can run once: opencode auth login  (stores creds in ~/.local/share/opencode/auth.json)"
    echonice "If you set LLM_API_KEY, this script maps it to PROVIDER_API_KEY (or uses --api-env)."

    ECHOHEAD "Example usage:"
    echonice "sake-llm-opencode . --files=./src/app/Tasks/*.php"
    echonice "sake-llm-opencode . --files=./src/**/*.php --dry-run"
    echonice "sake-llm-opencode . --files=./client/src/js/**/*.js --dry-run"
    echofunctions
    exit
}

############################################ HELP ONLY
sake_check_help_and_exit

############################################ FUNCTIONS

add_to_git_ignore() {
    set +e

    local ignoreLine='.agents/'

    touch .gitignore
    grep -Fqx "$ignoreLine" .gitignore || printf '%s\n' "$ignoreLine" >> .gitignore

    git rm -r --cached "${ignoreLine%/}/" >/dev/null 2>&1 || true
    git add .gitignore >/dev/null 2>&1 || true

    if ! git diff --cached --quiet >/dev/null 2>&1; then
        git commit -m 'FIX: Ignore local agent prompts' >/dev/null 2>&1 || true
    fi

    return 0
}

resolve_opencode_path() {
    local preferred="$1"

    if [[ -n "$preferred" && -f "$preferred" && -x "$preferred" ]]; then
        printf '%s' "$preferred"
        return 0
    fi

    local bin="$preferred"
    [[ -n "$bin" ]] || bin='opencode'

    local found
    found="$(command -v "$bin" 2>/dev/null || true)"
    [[ -n "$found" ]] || return 1
    printf '%s' "$found"
}

install_opencode() {
    bash -c "$OPEN_CODE_INSTALL_CMD"
}

provider_to_api_env() {
    local provider="$1"

    # common/known exceptions
    case "$provider" in
        google|gemini) printf '%s' 'GEMINI_API_KEY'; return 0 ;;
    esac

    # generic convention: PROVIDER_API_KEY
    local upper
    upper="$(printf '%s' "$provider" | tr '[:lower:]' '[:upper:]' | sed 's/[^A-Z0-9]/_/g')"
    printf '%s_API_KEY' "$upper"
}

############################################ INPUT RESOLUTION

cd "$WORKING_DIR"

prompt="${prompt:-"$SCRIPT_DIR/prompt.txt"}"

if [[ -z "${filesPattern:-}" ]]; then
    echobad "Error: --files=... is required (supports * globs)."
    help_and_exit
fi

if [[ ! -r "$prompt" ]]; then
    echobad "Error: cannot read prompt file: $prompt"
    exit 1
fi

echonice "Using prompt file: $prompt"
add_to_git_ignore

# Expand the glob safely
shopt -s nullglob
matches=( $filesPattern )
shopt -u nullglob

if (( ${#matches[@]} == 0 )); then
    echobad "Error: no files matched: $filesPattern"
    exit 1
fi

############################################ OPENCODE RESOLUTION

opencodeResolved="$(resolve_opencode_path "$opencodePath" 2>/dev/null || true)"
if [[ -z "$opencodeResolved" ]]; then
    echonice "opencode not found; installing..."
    install_opencode || { echobad "Error: failed to install opencode."; exit 1; }
    opencodeResolved="$(resolve_opencode_path "$opencodePath" 2>/dev/null || true)"
fi

if [[ -z "$opencodeResolved" ]]; then
    echobad "Error: opencode binary not found or not executable ($opencodePath)."
    exit 1
fi

############################################ MODEL / PROVIDER / AUTH

model="${modelOverride:-${LLM_MODEL:-$DEFAULT_MODEL}}"

# Ensure provider/model format (OpenCode expects this format)
if [[ "$model" != */* ]]; then
    model="openai/$model"
fi
provider="${model%%/*}"

# Determine which env var to populate (optional)
apiEnv="${apiEnvOverride:-$(provider_to_api_env "$provider")}"

# Pick an API key, if available (optional)
apiKey=''

# value from chosen source env var (default LLM_API_KEY)
sourceApiKey="${!apiKeyEnvName:-}"

if [[ -n "${apiKeyOverride:-}" ]]; then
    apiKey="$apiKeyOverride"
elif [[ -n "${apiEnvOverride:-}" && -n "${!apiEnvOverride:-}" ]]; then
    apiKey="${!apiEnvOverride}"
elif [[ -n "${!apiEnv:-}" ]]; then
    apiKey="${!apiEnv}"
elif [[ -n "$sourceApiKey" ]]; then
    apiKey="$sourceApiKey"
fi

promptText="$(cat "$prompt")"

cmd=( env )
if [[ -n "$apiKey" ]]; then
    cmd+=( "$apiEnv=$apiKey" )
fi

cmd+=( "$opencodeResolved" run -m "$model" )
for f in "${matches[@]}"; do
    cmd+=( -f "$f" )
done
cmd+=( -- "$promptText" )

if [[ "$dryRun" == "yes" ]]; then
    redactedCmd=( "${cmd[@]}" )
    for i in "${!redactedCmd[@]}"; do
        if [[ "${redactedCmd[$i]}" == *_API_KEY=* ]]; then
            redactedCmd[$i]="${redactedCmd[$i]%%=*}=***REDACTED***"
        fi
    done
    printf '%q ' "${redactedCmd[@]}"
    printf '\n'
    echoend
    exit 0
fi

"${cmd[@]}"
echoend
