#!/usr/bin/env bash

############################################ BASICS
SCRIPT_DIR="$COMPOSER_RUNTIME_BIN_DIR"
WORKING_DIR=$(pwd)
source $SCRIPT_DIR/sake-self-methods

############################################ DIR
dir="./"

############################################ SETTINGS
webpackDir='themes/sswebpack_engine_only/'
type=''
help='no'
while (($#)); do
    case $1 in
    -t | --type)
        type=$2
        shift
        ;;
    -h | --help)
        help='yes'
        shift
        ;;
    -*)
        printf 'Unknown option: %q\n\n' "$1"
        help='yes'
        ;;
    *) dir=$1 ;;
    esac
    shift
done

# ensure type is valid or default to patch
case "$type" in
  major|minor|patch) ;;  # valid
  *) type="patch" ;;     # default
esac

help_and_exit() {
    ECHOHEAD "NPM Publish on npmjs.org"

    ECHOHEAD "Current settings:"

    ECHOHEAD "Available settings:"
    echonice "-h, --help                    show help information"
    echonice "-t, --type                    $type (patch, minor, major)"

    ECHOHEAD "Example usage:"
    echonice "sake-npm-publish-on-npmjs-org -t minor"

    echofunctions
    exit
}

############################################ HELP ONLY
if [[ "$help" == "yes" ]]; then
    help_and_exit
fi

############################################ CODE

echonice "committing and pushing changes to git..."
sake-git-commit-and-push .

echonice "Checking if we are logged in to npmjs.org..."
if ! npm whoami > /dev/null 2>&1; then
  npm login
else
  echo "Already logged in as $(npm whoami)"
fi

echonice "Bumping version number..."
npm version "$type"

echonice "Bumping version to $(npm version | tail -n 1)"
echonice "Publishing to npmjs.org..."

npm publish --access public
sake-git-commit-and-push -m "MNT: pushing to npmjs.org"

echoend
