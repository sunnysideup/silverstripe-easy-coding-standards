#!/bin/bash


SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
WORKING_DIR=$(pwd)
source $SCRIPT_DIR/sake-methods

if [ "$1" != "" ]; then
    dir=$1;
else
    dir='vendor'
fi

help_and_exit() {
    echoline;
    echonice "   Available settings:";
    echoline;
    echonice "   -m, --message                  message - e.g. Lint";
    echonice "   -c, --commit-and-push          commit and push also? enter yes to execute";
    echonice "   -v, --new-version              create new tag? options are no|patch|minor|major";
    echonice "   -s, --status-only              check if there are any changes and there is a git folder present"
    echonice "   -f, --full-update              run a full composer update afterwards and commit";
    echonice " "
    echoline;
    echonice "   Example usage:"
    echoline;
    echonice "   sake-gitpush-vendor-packages  -m 'PATCH: lint'   -c yes  -v patch -f no   vendor/my-vendor-name";
    echoline;
    echonice " "
    echonice " "
    exit;
}

commitAndPush='yes'
message='WIP'
newVersion='no'
statusOnly='no'
fullUpdate='yes'
while (( $# )); do
  case $1 in
    -m|--message)          message=$2;shift ;;
    -c|--commit-and-push)  commitAndPush=$2;shift ;;
    -v|--new-version)      newVersion=$2;shift ;;
    -s|--status-only)      statusOnly=$2;shift ;;
    -f|--full-update)      fullUpdate=$2;shift ;;
    -*)                    printf 'Unknown option: %q\n\n' "$1";
                           help_and_exit 1 ;;
    *)                     dir=$1;;
  esac
  shift
done

echonice " "
echonice " "
echoline;
echonice "   Checking Vendor Packages for Changes";
echoline;
echonice "   Directory of script:           $SCRIPT_DIR";
echonice "   Directory to analyse:          $WORKING_DIR/$dir";
echoline;
echonice "   Message (-m):                  $message";
echonice "   Commit and Push (-c):          $commitAndPush";
echonice "   Create New tag (-v):           $newVersion";
echonice "   Status Only (-s):              $statusOnly";
echonice "   Full Composer Update (-f):     $statusOnly";
echoline;
echonice " "
echonice " "

echoline
echonice "   Removing folders that do not need to be there ..."
echoline

find $WORKING_DIR/$dir  -mindepth 2 -maxdepth 2 -type d -name "vendor"
find $WORKING_DIR/$dir  -mindepth 2 -maxdepth 2 -type d -name "vendor"  -exec rm "{}" -rf  \;
sake-remove-origs $dir

echoline
echonice "   going to look for folders in $WORKING_DIR/$dir"
echoline



find $WORKING_DIR/$dir -mindepth 1 -maxdepth 1 -type d -print0 |
    while IFS= read -r -d '' line; do
        echoline
        echonice "   DOING: $line"  ;
        echoline
        cd "$line";
        if [[ "$statusOnly" == "yes" ]]; then
            if test -f "./.git/config"; then
                git status -s
            else
                echobad " "
                echobad " "
                echoline;
                echobad "   ===  ERROR - NOT A GIT REPO ===";
                echobad "   "$WORKING_DIR/$dir;
                echobad "   "we tried to find the git dir: $GIT_DIR but that could not be found.;
                echobad "   "But that did not work.;
                echobad "   === IS NOT A GIT REPO       ===";
                echoline;
            fi
        else
            $SCRIPT_DIR/sake-gitpush . -m "$message" -c $commitAndPush -s $statusOnly  -v $newVersion ;
        fi
        cd -
    done

if [[ "$fullUpdate" == "yes" ]]; then
    composer update
    composer update

    $SCRIPT_DIR/sake-gitpush . -m "$message" -c $commitAndPush -s $statusOnly  -v $newVersion
fi

echoend;
