#!/usr/bin/env bash

############################################ BASICS
SCRIPT_DIR="${COMPOSER_RUNTIME_BIN_DIR:?COMPOSER_RUNTIME_BIN_DIR not set}"
WORKING_DIR=$(pwd)
source "$SCRIPT_DIR/sake-self-methods"

############################################ SETTINGS
server=''
toServer=''
help='no'
reverse='no'

while (($#)); do
    case $1 in
    -h | --help)
        help='yes'
        shift
        ;;
    -r | --reverse)
        reverse='yes'
        shift
        ;;
    -t | --to)
        toServer=$2
        shift
        ;;
    *)
        if sake_handle_help_flag "$1"; then
            shift
            continue
        fi
        server=$1
        ;;
    esac
    shift
done

if [[ "$server" != *":/"* ]]; then
    server="$server:/container/application"
fi

help_and_exit() {
    ECHOHEAD "Sync Database and Assets"
    echonice "Directory of script:           $SCRIPT_DIR"
    echonice "Working Directory:             $WORKING_DIR"
    echonice "Server to sync with:           $server"
    echonice "Do reverse sync:               $reverse"
    echonice "To server (if any):            $toServer"

    ECHOHEAD "Available settings:"
    echonice "-r, --reverse                  sync FROM local TO server"
    echonice "-t, --to SERVER[:/path]        after pulling, also push to another server"
    echonice "-h, --help                     show help information"

    ECHOHEAD "Example usage:"
    echonice "sake-ss-sync-all my-server:/var/www/website-root"
    echonice "sake-ss-sync-all my-server # default path is /container/application"
    echonice "sake-ss-sync-all my-server --reverse # sync from local to server - put reverse last"
    echonice "sake-ss-sync-all my-server --to other-server:/var/www/website-root"

    exit
}

if [[ "$help" == "yes" || -z "$server" ]]; then
    help_and_exit
fi

############################################ RUN COMMANDS

ECHOHEAD "Starting full sync with server: $server"
[[ -n "$toServer" ]] && echonice "To server: $toServer"

# Build argument lists dynamically
dbArgs=("$server")
assetArgs=("$server")

[[ "$reverse" == "yes" ]] && dbArgs+=("--reverse") && assetArgs+=("--reverse")
[[ -n "$toServer" && "$reverse" != "yes" ]] && dbArgs+=("--to" "$toServer") && assetArgs+=("--to" "$toServer")

sake-ss-rsync-db "${dbArgs[@]}"
sake-ss-rsync-assets "${assetArgs[@]}"

ECHOHEAD "Syncing all to/from server: $server COMPLETED"
echoend
